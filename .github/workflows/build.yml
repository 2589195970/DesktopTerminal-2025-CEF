name: Build DesktopTerminal-CEF

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  release:
    types: [published]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  BUILD_TYPE: Release
  QT_VERSION: '5.15.2'

jobs:
  # Windowsæž„å»ºï¼ˆæ”¯æŒ32ä½å’Œ64ä½ï¼‰
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86
            platform: Win32
            cef_version: "75.1.14+gc81164e+chromium-75.0.3770.100"
            qt_arch: win32_msvc2019
            name: "Windows 32-bit (CEF 75 - Maximum Compatibility)"
          - arch: x64
            platform: x64
            cef_version: "75.1.14+gc81164e+chromium-75.0.3770.100"
            qt_arch: win64_msvc2019_64
            name: "Windows 64-bit (CEF 75 - Maximum Compatibility)"

    name: ${{ matrix.name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3

    - name: Check Available Qt Architectures
      shell: cmd
      run: |
        echo "æ£€æŸ¥Qt ${{ env.QT_VERSION }}å¯ç”¨æž¶æž„..."
        python -m pip install aqtinstall==3.1.*
        python -m aqt list-qt windows desktop --arch ${{ env.QT_VERSION }} || echo "æž¶æž„æ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­å°è¯•å®‰è£…"

    - name: Install Qt ${{ env.QT_VERSION }}
      uses: jurplel/install-qt-action@v3
      timeout-minutes: 15
      with:
        version: ${{ env.QT_VERSION }}
        arch: ${{ matrix.qt_arch }}
        cache: true
        cache-key-prefix: qt-${{ matrix.qt_arch }}

    - name: Cache CEF ${{ matrix.arch }}
      id: cache-cef
      uses: actions/cache@v4
      with:
        path: third_party/cef
        key: cef-windows-${{ matrix.arch }}-${{ matrix.cef_version }}-verified-v6-stable
        restore-keys: |
          cef-windows-${{ matrix.arch }}-${{ matrix.cef_version }}-verified-v6-
          cef-windows-${{ matrix.arch }}-${{ matrix.cef_version }}-verified-

    - name: Verify CEF Cache Status
      id: verify-cef-cache  
      shell: cmd
      run: |
        setlocal enabledelayedexpansion
        echo "=== CEFç¼“å­˜çŠ¶æ€éªŒè¯ ==="
        
        REM æ ¹æ®æž¶æž„ç¡®å®šCEFç‰ˆæœ¬
        if "${{ matrix.arch }}"=="x86" (
          set "CEF_VERSION=${{ matrix.cef_version }}"
          set "CEF_PLATFORM=windows32"
        ) else (
          set "CEF_VERSION=${{ matrix.cef_version }}"
          set "CEF_PLATFORM=windows64"
        )
        
        echo "CEFé…ç½®ä¿¡æ¯:"
        echo "  æž¶æž„: ${{ matrix.arch }}"
        echo "  CEFç‰ˆæœ¬: !CEF_VERSION!"
        echo "  CEFå¹³å°: !CEF_PLATFORM!"
        echo "  ç¼“å­˜çŠ¶æ€: ${{ steps.cache-cef.outputs.cache-hit }}"
        
        set "CEF_BINARY_NAME=cef_binary_!CEF_VERSION!_!CEF_PLATFORM!"
        echo "  é¢„æœŸCEFç›®å½•: !CEF_BINARY_NAME!"
        
        REM éªŒè¯ç¼“å­˜å†…å®¹å®Œæ•´æ€§
        set "CEF_VALID=false"
        if "${{ steps.cache-cef.outputs.cache-hit }}"=="true" (
          echo "æ£€æŸ¥ç¼“å­˜çš„CEFå®Œæ•´æ€§..."
          if exist "third_party\cef\!CEF_BINARY_NAME!\include\cef_version.h" (
            if exist "third_party\cef\!CEF_BINARY_NAME!\Release\libcef.lib" (
              if exist "third_party\cef\!CEF_BINARY_NAME!\libcef_dll" (
                echo "âœ… CEFç¼“å­˜éªŒè¯é€šè¿‡ - æ‰€æœ‰å…³é”®æ–‡ä»¶å­˜åœ¨"
                set "CEF_VALID=true"
              ) else (
                echo "âœ— CEF Wrapperæºç ç¼ºå¤±"
              )
            ) else (
              echo "âœ— CEFä¸»åº“æ–‡ä»¶ç¼ºå¤±"
            )
          ) else (
            echo "âœ— CEFå¤´æ–‡ä»¶ç¼ºå¤±"
          )
        ) else (
          echo "æœªå‘½ä¸­ç¼“å­˜ï¼Œéœ€è¦ä¸‹è½½CEF"
        )
        
        if "!CEF_VALID!"=="false" (
          echo "æ¸…ç†ä¸å®Œæ•´çš„CEFç›®å½•..."
          if exist "third_party\cef" (
            rmdir /s /q "third_party\cef" 2>nul
          )
        )
        
        echo "cef-valid=!CEF_VALID!" >> %GITHUB_OUTPUT%
        echo "CEFéªŒè¯ç»“æžœ: !CEF_VALID!"

    - name: Download CEF
      if: steps.cache-cef.outputs.cache-hit != 'true' || steps.verify-cef-cache.outputs.cef-valid != 'true'
      shell: cmd
      run: |
        echo "ä¸‹è½½CEF for ${{ matrix.arch }}..."
        echo "å¼ºåˆ¶é‡æ–°ä¸‹è½½ä»¥ç¡®ä¿åº“æ–‡ä»¶å®Œæ•´..."
        if exist "third_party\cef" (
          echo "åˆ é™¤çŽ°æœ‰CEFç›®å½•ä»¥ç¡®ä¿å…¨æ–°å®‰è£…..."
          rmdir /s /q "third_party\cef"
        )
        if "${{ matrix.arch }}"=="x86" (
          scripts\download-cef.bat "/platform=windows32" "/force"
        ) else (
          scripts\download-cef.bat "/platform=windows64" "/force"
        )
        
        echo "=== è¯¦ç»†éªŒè¯ä¸‹è½½ç»“æžœ ==="
        if exist "third_party\cef" (
          echo "CEFæ ¹ç›®å½•å†…å®¹ï¼š"
          dir "third_party\cef" /b
          
          echo "æŸ¥æ‰¾æ‰€æœ‰åº“æ–‡ä»¶ï¼š"
          dir "third_party\cef" /s /b | findstr /i "\.lib$"
          
          echo "æŸ¥æ‰¾æ‰€æœ‰DLLæ–‡ä»¶ï¼š"
          dir "third_party\cef" /s /b | findstr /i "\.dll$"
          
          echo "æŸ¥æ‰¾å¤´æ–‡ä»¶ï¼š"
          dir "third_party\cef" /s /b | findstr /i "cef_version\.h$"
          
          REM ç‰¹åˆ«æ£€æŸ¥é¢„æœŸçš„åº“æ–‡ä»¶
          for /d %%d in ("third_party\cef\cef_binary_*") do (
            echo "=== æ£€æŸ¥ %%d ==="
            if exist "%%d\Release\libcef.lib" (
              echo "âœ“ æ‰¾åˆ°ä¸»åº“: %%d\Release\libcef.lib"
              for %%f in ("%%d\Release\libcef.lib") do echo "  å¤§å°: %%~zf bytes"
            ) else (
              echo "âœ— ä¸»åº“ç¼ºå¤±: %%d\Release\libcef.lib"
            )
            
            if exist "%%d\libcef_dll" (
              echo "âœ“ Wrapperæºç å­˜åœ¨: %%d\libcef_dll"
            ) else (
              echo "âœ— Wrapperæºç ç¼ºå¤±: %%d\libcef_dll"
            )
          )
        ) else (
          echo "âœ— CEFç›®å½•ä¸‹è½½å¤±è´¥ï¼"
        )

    - name: Final CEF Verification
      shell: cmd
      run: |
        echo "=== è¯¦ç»†CEFéªŒè¯ ==="
        echo "æ£€æŸ¥CEFç›®å½•ç»“æž„å’Œå…³é”®æ–‡ä»¶..."
        
        if exist "third_party\cef" (
          echo "CEFæ ¹ç›®å½•å†…å®¹ï¼š"
          dir "third_party\cef" /b
          
          REM æŸ¥æ‰¾æ‰€æœ‰cef_binaryç›®å½•
          for /d %%d in ("third_party\cef\cef_binary_*") do (
            echo "=== æ£€æŸ¥ %%d ==="
            if exist "%%d\include\cef_version.h" (
              echo "âœ“ å¤´æ–‡ä»¶å­˜åœ¨: %%d\include\cef_version.h"
            ) else (
              echo "âœ— å¤´æ–‡ä»¶ç¼ºå¤±: %%d\include\cef_version.h"
            )
            
            if exist "%%d\Release" (
              echo "âœ“ Releaseç›®å½•å­˜åœ¨ï¼Œå†…å®¹ï¼š"
              dir "%%d\Release" /b | findstr /i "\.lib"
              if exist "%%d\Release\libcef.lib" (
                echo "âœ“ å…³é”®åº“æ–‡ä»¶å­˜åœ¨: libcef.lib"
              ) else (
                echo "âœ— å…³é”®åº“æ–‡ä»¶ç¼ºå¤±: libcef.lib"
              )
            ) else (
              echo "âœ— Releaseç›®å½•ç¼ºå¤±"
            )
            
            if exist "%%d\libcef_dll" (
              echo "âœ“ CEF Wrapperæºç ç›®å½•å­˜åœ¨"
              dir "%%d\libcef_dll" /b | findstr /i "\.h \.cc"
            ) else (
              echo "âœ— CEF Wrapperæºç ç›®å½•ç¼ºå¤±"
            )
          )
        ) else (
          echo "âœ— CEFç›®å½•å®Œå…¨ä¸å­˜åœ¨ï¼"
        )
        setlocal enabledelayedexpansion
        echo "æœ€ç»ˆCEFéªŒè¯..."
        set "VERIFICATION_FAILED=false"
        
        REM æ ¹æ®æž¶æž„ç¡®å®šCEFç‰ˆæœ¬å’Œè·¯å¾„
        if "${{ matrix.arch }}"=="x86" (
          set "CEF_VERSION=${{ matrix.cef_version }}"
          set "CEF_PLATFORM=windows32"
        ) else (
          set "CEF_VERSION=${{ matrix.cef_version }}"
          set "CEF_PLATFORM=windows64"
        )
        
        set "CEF_BINARY_NAME=cef_binary_!CEF_VERSION!_!CEF_PLATFORM!"
        
        REM æ”¯æŒå¤šç§CEFç›®å½•ç»“æž„çš„éªŒè¯
        echo "æ£€æŸ¥CEFç›®å½•ç»“æž„çš„å¤šç§å¯èƒ½æ€§..."
        
        REM æ£€æŸ¥å…³é”®CEFå¤´æ–‡ä»¶
        set "HEADER_FILES=cef_version.h cef_app.h cef_client.h"
        set "HEADERS_FOUND=0"
        
        for %%h in (!HEADER_FILES!) do (
          set "HEADER_FOUND=false"
          
          REM å¤šè·¯å¾„æ£€æŸ¥å¤´æ–‡ä»¶
          set "HEADER_PATHS[1]=third_party\cef\!CEF_BINARY_NAME!\include\%%h"
          set "HEADER_PATHS[2]=third_party\cef\include\%%h"
          set "HEADER_PATHS[3]=third_party\cef\!CEF_BINARY_NAME!\%%h"
          
          for /l %%i in (1,1,3) do (
            if "!HEADER_FOUND!"=="false" (
              if exist "!HEADER_PATHS[%%i]!" (
                echo "âœ“ æ‰¾åˆ°å¤´æ–‡ä»¶: %%h at !HEADER_PATHS[%%i]!"
                set "HEADER_FOUND=true"
                set /a HEADERS_FOUND+=1
              )
            )
          )
          
          if "!HEADER_FOUND!"=="false" (
            echo "âœ— ç¼ºå¤±å¤´æ–‡ä»¶: %%h"
            set "VERIFICATION_FAILED=true"
          )
        )
        
        REM æ£€æŸ¥CEFåº“æ–‡ä»¶ï¼ˆæ›´çµæ´»çš„è·¯å¾„ï¼‰
        set "LIB_FOUND=false"
        set "LIB_PATHS[1]=third_party\cef\!CEF_BINARY_NAME!\Release\libcef.lib"
        set "LIB_PATHS[2]=third_party\cef\Release\libcef.lib"
        set "LIB_PATHS[3]=third_party\cef\!CEF_BINARY_NAME!\lib\libcef.lib"
        
        for /l %%i in (1,1,3) do (
          if "!LIB_FOUND!"=="false" (
            if exist "!LIB_PATHS[%%i]!" (
              echo "âœ“ æ‰¾åˆ°CEFåº“æ–‡ä»¶: !LIB_PATHS[%%i]!"
              set "LIB_FOUND=true"
            )
          )
        )
        
        if "!LIB_FOUND!"=="false" (
          echo "âœ— ç¼ºå¤±CEFåº“æ–‡ä»¶(libcef.lib)"
          set "VERIFICATION_FAILED=true"
        )
        
        REM æœ€ç»ˆéªŒè¯ç»“æžœ
        if "!VERIFICATION_FAILED!"=="true" (
          echo "âŒ CEFéªŒè¯å¤±è´¥ - éƒ¨åˆ†å…³é”®æ–‡ä»¶ç¼ºå¤±"
          echo "æ‰¾åˆ°çš„å¤´æ–‡ä»¶æ•°é‡: !HEADERS_FOUND!/3"
          echo "CEFç›®å½•ç»“æž„ï¼ˆç”¨äºŽè¯Šæ–­ï¼‰:"
          if exist "third_party\cef" (
            echo "--- CEFå¤´æ–‡ä»¶ ---"
            dir "third_party\cef" /s /b | findstr /i "\.h$" | findstr /i "cef" | head -10
            echo "--- CEFåº“æ–‡ä»¶ ---"  
            dir "third_party\cef" /s /b | findstr /i "\.lib$" | head -5
            echo "--- ç›®å½•ç»“æž„ ---"
            tree "third_party\cef" /F || dir "third_party\cef" /s /b | head -20
          )
          exit /b 1
        ) else (
          echo "âœ… CEFéªŒè¯æˆåŠŸ - æ‰€æœ‰å…³é”®æ–‡ä»¶éƒ½å­˜åœ¨"
          echo "âœ… æ‰¾åˆ°å¤´æ–‡ä»¶: !HEADERS_FOUND!/3"
          echo "âœ… æ‰¾åˆ°åº“æ–‡ä»¶: libcef.lib"
          echo "CEFå®‰è£…è·¯å¾„: third_party\cef\!CEF_BINARY_NAME!"
        )

    - name: Pre-Build Environment Diagnostics
      shell: cmd
      run: |
        echo "=== æž„å»ºçŽ¯å¢ƒè¯Šæ–­æŠ¥å‘Š ==="
        echo "æ”¶é›†çŽ¯å¢ƒä¿¡æ¯ä»¥ååŠ©é—®é¢˜è¯Šæ–­..."
        
        echo "--- ç³»ç»Ÿä¿¡æ¯ ---"
        echo "æ“ä½œç³»ç»Ÿ: %OS%"
        echo "å¤„ç†å™¨æž¶æž„: %PROCESSOR_ARCHITECTURE%"
        echo "å¤„ç†å™¨æ ‡è¯†: %PROCESSOR_IDENTIFIER%"
        echo "æž„å»ºæž¶æž„: ${{ matrix.arch }}"
        echo "Qtæž¶æž„: ${{ matrix.qt_arch }}"
        
        echo "--- QtçŽ¯å¢ƒ ---"
        echo "Qt5_Dir: %Qt5_Dir%"
        if exist "%Qt5_Dir%" (
          echo "âœ“ Qt5ç›®å½•å­˜åœ¨"
          echo "Qt5ç‰ˆæœ¬ä¿¡æ¯:"
          if exist "%Qt5_Dir%\bin\qmake.exe" (
            "%Qt5_Dir%\bin\qmake.exe" -query QT_VERSION 2>nul || echo "æ— æ³•èŽ·å–Qtç‰ˆæœ¬"
          )
        ) else (
          echo "âœ— Qt5ç›®å½•ä¸å­˜åœ¨"
        )
        
        echo "--- CEFçŽ¯å¢ƒæ£€æŸ¥ ---"
        if exist "third_party\cef" (
          echo "âœ“ CEFç›®å½•å­˜åœ¨"
          echo "CEFç›®å½•å¤§å°å’Œå†…å®¹:"
          for /d %%d in ("third_party\cef\cef_binary_*") do (
            echo "  CEFç›®å½•: %%d"
            if exist "%%d\Release\libcef.lib" (
              for %%f in ("%%d\Release\libcef.lib") do echo "    libcef.lib: %%~zf bytes"
            ) else (
              echo "    âœ— libcef.libç¼ºå¤±"
            )
            if exist "%%d\include\cef_version.h" (
              echo "    âœ“ å¤´æ–‡ä»¶å­˜åœ¨"
            ) else (
              echo "    âœ— å¤´æ–‡ä»¶ç¼ºå¤±"
            )
          )
        ) else (
          echo "âœ— CEFç›®å½•ä¸å­˜åœ¨ - è¿™å°†å¯¼è‡´æž„å»ºå¤±è´¥"
        )
        
        echo "--- ç¼–è¯‘å·¥å…·é“¾ ---"
        echo "Visual Studioç‰ˆæœ¬:"
        where cl 2>nul && cl 2>&1 | findstr "Version" || echo "æ— æ³•æ‰¾åˆ°clç¼–è¯‘å™¨"
        echo "CMakeç‰ˆæœ¬:"
        cmake --version 2>nul || echo "æ— æ³•æ‰¾åˆ°cmake"
        echo "MSBuildç‰ˆæœ¬:"
        where msbuild 2>nul && msbuild -version 2>nul || echo "æ— æ³•æ‰¾åˆ°msbuild"
        
        echo "--- ç£ç›˜ç©ºé—´ ---"
        for %%d in (C: D:) do (
          if exist %%d\ (
            for /f "tokens=3" %%a in ('dir %%d\ /-c ^| find "bytes free"') do echo "%%d å¯ç”¨ç©ºé—´: %%a bytes"
          )
        )
        
        echo "=== è¯Šæ–­æŠ¥å‘Šå®Œæˆ ==="

    - name: Configure CMake
      shell: cmd
      run: |
        echo "=== CMakeé…ç½®é˜¶æ®µ ==="
        echo "Qt5_Dir environment: %Qt5_Dir%"
        echo "å½“å‰å·¥ä½œç›®å½•: %CD%"
        echo "éªŒè¯æž„å»ºçŽ¯å¢ƒ..."
        
        REM æ£€æŸ¥å…³é”®ä¾èµ–
        if not exist "%Qt5_Dir%" (
          echo "âŒ Qt5ç›®å½•ä¸å­˜åœ¨: %Qt5_Dir%"
          exit /b 1
        )
        
        if not exist "third_party\cef" (
          echo "âŒ CEFç›®å½•ä¸å­˜åœ¨ - è¿™å°†å¯¼è‡´CMakeé…ç½®å¤±è´¥"
          exit /b 1
        )
        
        echo "âœ… åŸºç¡€ä¾èµ–æ£€æŸ¥é€šè¿‡"
        mkdir build 2>nul
        cd build
        
        echo "--- CMakeé…ç½®å¼€å§‹ ---"
        REM Configure for Windows 7 SP1 compatibility
        if "${{ matrix.arch }}"=="x86" (
          echo "é…ç½®Windows 7 SP1 32ä½å…¼å®¹æ€§æž„å»º..."
          cmake .. ^
            -A ${{ matrix.platform }} ^
            -T v142 ^
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
            -DCEF_VERSION="${{ matrix.cef_version }}" ^
            -DCMAKE_PREFIX_PATH="%Qt5_Dir%" ^
            -DQt5_DIR="%Qt5_Dir%/lib/cmake/Qt5" ^
            -DCMAKE_SYSTEM_VERSION=7.1 ^
            -DCMAKE_VERBOSE_MAKEFILE=ON
        ) else (
          echo "é…ç½®Windows 10+ 64ä½æž„å»º..."
          cmake .. ^
            -A ${{ matrix.platform }} ^
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
            -DCEF_VERSION="${{ matrix.cef_version }}" ^
            -DCMAKE_PREFIX_PATH="%Qt5_Dir%" ^
            -DQt5_DIR="%Qt5_Dir%/lib/cmake/Qt5" ^
            -DCMAKE_VERBOSE_MAKEFILE=ON
        )
        
        if %errorlevel% neq 0 (
          echo "âŒ CMakeé…ç½®å¤±è´¥"
          echo "é”™è¯¯çº§åˆ«: %errorlevel%"
          echo "--- CMakeé”™è¯¯è¯Šæ–­ ---"
          echo "CMakeCache.txtå†…å®¹ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰:"
          if exist "CMakeCache.txt" (
            findstr /i "cef\|qt\|error" CMakeCache.txt || echo "æœªæ‰¾åˆ°ç›¸å…³é”™è¯¯ä¿¡æ¯"
          ) else (
            echo "CMakeCache.txtä¸å­˜åœ¨"
          )
          echo "CMakeFiles/CMakeError.logå†…å®¹ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰:"
          if exist "CMakeFiles\CMakeError.log" (
            type "CMakeFiles\CMakeError.log"
          ) else (
            echo "CMakeError.logä¸å­˜åœ¨"
          )
          exit /b 1
        ) else (
          echo "âœ… CMakeé…ç½®æˆåŠŸ"
          
          REM æ­£ç¡®è®¾ç½®çŽ¯å¢ƒå˜é‡ç»™åŽç»­æ­¥éª¤
          echo CMAKE_CONFIG_SUCCESS=true>>%GITHUB_ENV%
          echo CMAKE_BUILD_DIR=%CD%>>%GITHUB_ENV%
          
          echo "--- çŽ¯å¢ƒå˜é‡è®¾ç½®éªŒè¯ ---"
          echo "è®¾ç½®CMAKE_CONFIG_SUCCESS=true"
          echo "è®¾ç½®CMAKE_BUILD_DIR=%CD%"
          
          echo "--- é…ç½®éªŒè¯ ---"
          echo "è§£å†³æ–¹æ¡ˆæ–‡ä»¶:"
          dir *.sln /b || echo "æœªæ‰¾åˆ°è§£å†³æ–¹æ¡ˆæ–‡ä»¶"
          echo "é¡¹ç›®æ–‡ä»¶:"
          dir *.vcxproj /b | head -5 || echo "æœªæ‰¾åˆ°é¡¹ç›®æ–‡ä»¶"
          echo "ðŸŽ¯ å‡†å¤‡æ‰§è¡Œæž„å»ºæ­¥éª¤..."
        )

    - name: Build Project  
      shell: cmd
      run: |
        setlocal enabledelayedexpansion
        echo "=== é¡¹ç›®ç¼–è¯‘é˜¶æ®µ ==="
        
        echo "--- çŽ¯å¢ƒå˜é‡è¯»å–éªŒè¯ ---"
        echo "CMAKE_CONFIG_SUCCESSçŽ¯å¢ƒå˜é‡: '%CMAKE_CONFIG_SUCCESS%'"
        echo "CMAKE_BUILD_DIRçŽ¯å¢ƒå˜é‡: '%CMAKE_BUILD_DIR%'"
        
        REM éªŒè¯å‰ç½®æ¡ä»¶
        if not "%CMAKE_CONFIG_SUCCESS%"=="true" (
          echo "âŒ CMakeé…ç½®æœªæˆåŠŸï¼Œæ— æ³•ç»§ç»­æž„å»º"
          echo "CMAKE_CONFIG_SUCCESS='%CMAKE_CONFIG_SUCCESS%' (åº”è¯¥æ˜¯'true')"
          echo "è¿™è¡¨æ˜ŽçŽ¯å¢ƒå˜é‡ä¼ é€’å¤±è´¥æˆ–CMakeé…ç½®æ­¥éª¤æœªæˆåŠŸ"
          echo "è¯·æ£€æŸ¥å‰ä¸€æ­¥éª¤çš„çŽ¯å¢ƒå˜é‡è®¾ç½®"
          exit /b 1
        ) else (
          echo "âœ… çŽ¯å¢ƒå˜é‡éªŒè¯é€šè¿‡ï¼šCMAKE_CONFIG_SUCCESS=true"
        )
        
        if not exist "%CMAKE_BUILD_DIR%" (
          echo "âŒ æž„å»ºç›®å½•ä¸å­˜åœ¨: %CMAKE_BUILD_DIR%"
          echo "å°è¯•ä½¿ç”¨é»˜è®¤æž„å»ºç›®å½•..."
          if exist "build" (
            echo "âœ“ æ‰¾åˆ°é»˜è®¤æž„å»ºç›®å½•"
            cd build
          ) else (
            echo "âŒ æ— æ³•æ‰¾åˆ°ä»»ä½•æž„å»ºç›®å½•"
            exit /b 1
          )
        ) else (
          echo "âœ“ ä½¿ç”¨é…ç½®çš„æž„å»ºç›®å½•: %CMAKE_BUILD_DIR%"
          cd "%CMAKE_BUILD_DIR%"
        )
        
        echo "--- ç¼–è¯‘å‰æœ€åŽæ£€æŸ¥ ---"
        echo "å½“å‰å·¥ä½œç›®å½•: %CD%"
        echo "æž„å»ºç›®å½•å†…å®¹:"
        dir . /b
        
        echo "æ£€æŸ¥ç”Ÿæˆçš„é¡¹ç›®æ–‡ä»¶:"
        if exist "*.sln" (
          for %%f in (*.sln) do echo "âœ“ è§£å†³æ–¹æ¡ˆæ–‡ä»¶: %%f"
        ) else (
          echo "âœ— æœªæ‰¾åˆ°è§£å†³æ–¹æ¡ˆæ–‡ä»¶"
          echo "âŒ è¿™è¡¨æ˜ŽCMakeé…ç½®å¯èƒ½æœªå®Œå…¨æˆåŠŸ"
          exit /b 1
        )
        
        if exist "*.vcxproj" (
          echo "âœ“ æ‰¾åˆ°é¡¹ç›®æ–‡ä»¶"
          echo "é¡¹ç›®æ–‡ä»¶åˆ—è¡¨:"
          dir *.vcxproj /b | head -10
        ) else (
          echo "âœ— æœªæ‰¾åˆ°é¡¹ç›®æ–‡ä»¶"
          echo "âŒ è¿™è¡¨æ˜ŽCMakeé…ç½®å¯èƒ½æœªå®Œå…¨æˆåŠŸ"
          exit /b 1
        )
        
        echo "--- å¼€å§‹ç¼–è¯‘ ---"
        echo "ç¼–è¯‘é…ç½®: ${{ env.BUILD_TYPE }}"
        echo "å¹¶è¡Œæ•°: %NUMBER_OF_PROCESSORS%"
        echo "ç›®æ ‡å¹³å°: ${{ matrix.platform }}"
        
        echo "ðŸ”¨ æ‰§è¡Œæž„å»ºå‘½ä»¤..."
        echo "å‘½ä»¤: cmake --build . --config ${{ env.BUILD_TYPE }} --parallel %NUMBER_OF_PROCESSORS% --verbose"
        
        REM è®¾ç½®è¯¦ç»†è¾“å‡ºä»¥ä¾¿è¯Šæ–­é“¾æŽ¥é”™è¯¯
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel %NUMBER_OF_PROCESSORS% --verbose
        
        set "BUILD_RESULT=%errorlevel%"
        echo "æž„å»ºå‘½ä»¤å®Œæˆï¼Œè¿”å›žç : %BUILD_RESULT%"
        
        if !BUILD_RESULT! neq 0 (
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯çº§åˆ«: !BUILD_RESULT!"
          echo "--- ç¼–è¯‘é”™è¯¯è¯Šæ–­ ---"
          
          REM æ£€æŸ¥æ˜¯å¦æ˜¯é“¾æŽ¥é”™è¯¯ï¼ˆLNK2019ç­‰ï¼‰
          if exist "*.log" (
            echo "æ£€æŸ¥æž„å»ºæ—¥å¿—ä¸­çš„é“¾æŽ¥é”™è¯¯..."
            for %%f in (*.log) do (
              findstr /i "LNK2019\|LNK1120\|unresolved external symbol" "%%f" && (
                echo "å‘çŽ°é“¾æŽ¥é”™è¯¯åœ¨: %%f"
                echo "--- é“¾æŽ¥é”™è¯¯è¯¦æƒ… ---"
                findstr /i "LNK\|unresolved\|external symbol" "%%f"
              )
            )
          )
          
          REM æ£€æŸ¥æž„å»ºè¾“å‡ºç›®å½•
          echo "--- æž„å»ºè¾“å‡ºæ£€æŸ¥ ---"
          if exist "bin" (
            echo "binç›®å½•å†…å®¹:"
            dir bin /s /b
          ) else (
            echo "binç›®å½•ä¸å­˜åœ¨"
          )
          
          if exist "lib" (
            echo "libç›®å½•å†…å®¹:"
            dir lib /s /b
          ) else (
            echo "libç›®å½•ä¸å­˜åœ¨"
          )
          
          REM æ£€æŸ¥ä¸­é—´æ–‡ä»¶
          echo "--- ä¸­é—´æ–‡ä»¶æ£€æŸ¥ ---"
          dir /s /b *.obj | head -10 && echo "..." || echo "æœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶"
          dir /s /b *.lib | head -10 && echo "..." || echo "æœªæ‰¾åˆ°åº“æ–‡ä»¶"
          
          echo "--- é”™è¯¯æ€»ç»“ ---"
          echo "è¿™å¾ˆå¯èƒ½æ˜¯CEFåº“é“¾æŽ¥é—®é¢˜å¯¼è‡´çš„LNK2019é”™è¯¯"
          echo "è¯·æ£€æŸ¥ä»¥ä¸Šè¯Šæ–­ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯é“¾æŽ¥é”™è¯¯è¯¦æƒ…"
          
          exit /b !BUILD_RESULT!
        ) else (
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "--- ç¼–è¯‘ç»“æžœéªŒè¯ ---"
          
          REM éªŒè¯ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
          if exist "bin\${{ env.BUILD_TYPE }}\DesktopTerminal-CEF.exe" (
            echo "âœ… ä¸»ç¨‹åºæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            for %%f in ("bin\${{ env.BUILD_TYPE }}\DesktopTerminal-CEF.exe") do (
              echo "  æ–‡ä»¶å¤§å°: %%~zf bytes"
            )
          ) else (
            echo "âš ï¸ ä¸»ç¨‹åºæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œä½†ç¼–è¯‘æŠ¥å‘ŠæˆåŠŸ"
            echo "æ£€æŸ¥binç›®å½•ç»“æž„:"
            if exist "bin" (
              dir bin /s /b
            ) else (
              echo "binç›®å½•ä¸å­˜åœ¨"
            )
          )
          
          REM éªŒè¯ç”Ÿæˆçš„åº“æ–‡ä»¶
          if exist "lib\${{ env.BUILD_TYPE }}\*.lib" (
            echo "âœ… åº“æ–‡ä»¶ç”Ÿæˆ:"
            dir "lib\${{ env.BUILD_TYPE }}\*.lib" /b
          ) else (
            echo "â„¹ï¸ æœªæ‰¾åˆ°ç”Ÿæˆçš„åº“æ–‡ä»¶ï¼ˆå¯èƒ½æ­£å¸¸ï¼‰"
          )
          
          echo "ðŸŽ‰ Windows ${{ matrix.arch }}ä½æž„å»ºå®Œæˆï¼"
          
          REM æ­£ç¡®è®¾ç½®æž„å»ºæˆåŠŸçŽ¯å¢ƒå˜é‡
          echo BUILD_SUCCESS=true>>%GITHUB_ENV%
          echo "--- æž„å»ºæˆåŠŸæ€»ç»“ ---"
          echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆ"
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶åº”å·²ç”Ÿæˆ"
          echo "âœ… åº“æ–‡ä»¶å·²ç¼–è¯‘"
          echo "âœ… è®¾ç½®BUILD_SUCCESS=true"
          echo "ðŸŽ¯ å‡†å¤‡è¿›è¡Œæž„å»ºéªŒè¯..."
        )

    - name: Verify Build
      shell: cmd
      run: |
        echo "=== æž„å»ºéªŒè¯é˜¶æ®µ ==="
        echo "æ£€æŸ¥æž„å»ºäº§ç‰©..."
        
        REM é¦–å…ˆæ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
        echo "å½“å‰å·¥ä½œç›®å½•: %CD%"
        
        REM æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„ä½ç½® - ä½¿ç”¨æ ‡å‡†æ‰¹å¤„ç†è¯­æ³•
        set "FOUND_EXE=false"
        
        REM æ£€æŸ¥ç¬¬ä¸€ä¸ªä½ç½®: build\bin\Release\DesktopTerminal-CEF.exe
        set "EXE_PATH1=build\bin\${{ env.BUILD_TYPE }}\DesktopTerminal-CEF.exe"
        if exist "%EXE_PATH1%" (
          echo "âœ“ æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: %EXE_PATH1%"
          for %%f in ("%EXE_PATH1%") do echo "  æ–‡ä»¶å¤§å°: %%~zf bytes"
          set "FOUND_EXE=true"
          goto :found_exe
        ) else (
          echo "âœ— æœªæ‰¾åˆ°: %EXE_PATH1%"
        )
        
        REM æ£€æŸ¥ç¬¬äºŒä¸ªä½ç½®: build\bin\Release\DesktopTerminal-CEF.exe
        set "EXE_PATH2=build\bin\Release\DesktopTerminal-CEF.exe"
        if exist "%EXE_PATH2%" (
          echo "âœ“ æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: %EXE_PATH2%"
          for %%f in ("%EXE_PATH2%") do echo "  æ–‡ä»¶å¤§å°: %%~zf bytes"
          set "FOUND_EXE=true"
          goto :found_exe
        ) else (
          echo "âœ— æœªæ‰¾åˆ°: %EXE_PATH2%"
        )
        
        REM æ£€æŸ¥ç¬¬ä¸‰ä¸ªä½ç½®: build\Release\DesktopTerminal-CEF.exe
        set "EXE_PATH3=build\${{ env.BUILD_TYPE }}\DesktopTerminal-CEF.exe"
        if exist "%EXE_PATH3%" (
          echo "âœ“ æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: %EXE_PATH3%"
          for %%f in ("%EXE_PATH3%") do echo "  æ–‡ä»¶å¤§å°: %%~zf bytes"
          set "FOUND_EXE=true"
          goto :found_exe
        ) else (
          echo "âœ— æœªæ‰¾åˆ°: %EXE_PATH3%"
        )
        
        REM æ£€æŸ¥ç¬¬å››ä¸ªä½ç½®: bin\Release\DesktopTerminal-CEF.exe
        set "EXE_PATH4=bin\${{ env.BUILD_TYPE }}\DesktopTerminal-CEF.exe"
        if exist "%EXE_PATH4%" (
          echo "âœ“ æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: %EXE_PATH4%"
          for %%f in ("%EXE_PATH4%") do echo "  æ–‡ä»¶å¤§å°: %%~zf bytes"
          set "FOUND_EXE=true"
          goto :found_exe
        ) else (
          echo "âœ— æœªæ‰¾åˆ°: %EXE_PATH4%"
        )
        
        :found_exe
        if "%FOUND_EXE%"=="true" (
          echo "ðŸŽ‰ æž„å»ºéªŒè¯æˆåŠŸï¼"
          echo BUILD_SUCCESS=true>>%GITHUB_ENV%
          echo "âœ… è®¾ç½®BUILD_SUCCESS=trueä»¥ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨"
        ) else (
          echo "âŒ æž„å»ºéªŒè¯å¤±è´¥ - æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          echo "--- è¯¦ç»†è¯Šæ–­ ---"
          echo "æž„å»ºç›®å½•å®Œæ•´ç»“æž„:"
          if exist "build" (
            dir build /s /b | findstr /i "\.exe$" || echo "æœªæ‰¾åˆ°ä»»ä½•exeæ–‡ä»¶"
            echo "--- binç›®å½•å†…å®¹ ---"
            if exist "build\bin" (
              dir "build\bin" /s /b
            ) else (
              echo "build\binç›®å½•ä¸å­˜åœ¨"
            )
          ) else (
            echo "buildç›®å½•ä¸å­˜åœ¨ï¼"
          )
          echo BUILD_SUCCESS=false>>%GITHUB_ENV%
          echo "âœ… è®¾ç½®BUILD_SUCCESS=false"
          exit 1
        )

    - name: Package Windows Build
      if: env.BUILD_SUCCESS == 'true'
      shell: powershell
      run: |
        Write-Host "=== Windowsæž„å»ºæ‰“åŒ…é˜¶æ®µ ==="
        Write-Host "BUILD_SUCCESS: $env:BUILD_SUCCESS"
        
        if ($env:BUILD_SUCCESS -ne 'true') {
          Write-Host "âŒ æž„å»ºæœªæˆåŠŸï¼Œè·³è¿‡æ‰“åŒ…"
          exit 1
        }
        
        $artifactPath = "artifacts\windows-${{ matrix.arch }}"
        Write-Host "åˆ›å»ºæ‰“åŒ…ç›®å½•: $artifactPath"
        New-Item -ItemType Directory -Force -Path $artifactPath
        
        # Copy main executable and dependencies
        Copy-Item "build\bin\${{ env.BUILD_TYPE }}\*" "$artifactPath\" -Recurse -Force
        
        # Copy documentation
        Copy-Item "README.md" "$artifactPath\"
        Copy-Item "todo.md" "$artifactPath\"
        
        # Copy resources for installer
        if (Test-Path "resources") {
          New-Item -ItemType Directory -Force -Path "$artifactPath\resources"
          Copy-Item "resources\*" "$artifactPath\resources\" -Recurse -Force
        }
        
        # Create version info using array join to avoid backtick issues
        $arch = "${{ matrix.arch }}"
        $platform = "${{ matrix.name }}"
        $cefVersion = "${{ matrix.cef_version }}"
        $qtVersion = "${{ env.QT_VERSION }}"
        $buildType = "${{ env.BUILD_TYPE }}"
        $commitSha = "${{ github.sha }}"
        $buildDate = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
        
        $buildInfoLines = @(
          "DesktopTerminal-CEF Build Information",
          "====================================",
          "Architecture: $arch",
          "Platform: $platform", 
          "CEF Version: $cefVersion",
          "Qt Version: $qtVersion",
          "Build Type: $buildType",
          "Build Date: $buildDate",
          "Commit: $commitSha"
        )
        $buildInfo = $buildInfoLines -join [Environment]::NewLine
        Set-Content -Path "$artifactPath\BUILD_INFO.txt" -Encoding UTF8 -Value $buildInfo

    - name: Create Windows Installer
      shell: cmd
      run: |
        setlocal enabledelayedexpansion
        echo "=== å®‰è£…NSIS ==="
        choco install nsis -y
        
        echo "=== ç”Ÿæˆ${{ matrix.arch }}ä½CEFå®‰è£…åŒ… ==="
        mkdir Output 2>nul
        
        echo "æ£€æŸ¥NSISè„šæœ¬..."
        if not exist installer.nsi (
          echo ERROR: installer.nsiæ–‡ä»¶ä¸å­˜åœ¨
          exit /b 1
        )
        
        echo "æ£€æŸ¥æž„å»ºäº§ç‰©..."
        if exist "build\bin\${{ env.BUILD_TYPE }}\DesktopTerminal-CEF.exe" (
          echo "âœ“ æ‰¾åˆ°ä¸»ç¨‹åºæ–‡ä»¶"
          dir "build\bin\${{ env.BUILD_TYPE }}"
        ) else (
          echo "âœ— æœªæ‰¾åˆ°ä¸»ç¨‹åºæ–‡ä»¶"
          echo "æž„å»ºç›®å½•å†…å®¹ï¼š"
          dir build /s
          exit /b 1
        )
        
        REM æå–CEFä¸»ç‰ˆæœ¬å·
        set "cef_version_full=${{ matrix.cef_version }}"
        for /f "tokens=1 delims=." %%a in ("!cef_version_full!") do set "cef_major=%%a"
        
        echo "ç”ŸæˆCEF ${{ matrix.arch }}ä½å®‰è£…åŒ… (CEF !cef_major!)..."
        makensis -DARCH=${{ matrix.arch }} -DCEF_VERSION=!cef_major! installer.nsi
        if %errorlevel% neq 0 (
          echo ç”Ÿæˆ${{ matrix.arch }}ä½å®‰è£…åŒ…å¤±è´¥
          exit /b 1
        )
        
        echo "ç”Ÿæˆçš„å®‰è£…åŒ…ï¼š"
        dir Output\*.exe
        
        REM é‡å‘½åå®‰è£…åŒ…åŒ…å«å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯
        for %%f in (Output\*.exe) do (
          if "${{ matrix.arch }}"=="x86" (
            set "new_name=DesktopTerminal-CEF-v1.0.0-${{ matrix.arch }}-cef!cef_major!-win7-setup.exe"
          ) else (
            set "new_name=DesktopTerminal-CEF-v1.0.0-${{ matrix.arch }}-cef!cef_major!-setup.exe"
          )
          ren "%%f" "!new_name!"
          echo é‡å‘½å: %%f -^> !new_name!
        )

    - name: Upload Windows ${{ matrix.arch }} Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DesktopTerminal-CEF-windows-${{ matrix.arch }}
        path: artifacts/windows-${{ matrix.arch }}/
        retention-days: 30

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: DesktopTerminal-CEF-installer-${{ matrix.arch }}
        path: Output/*.exe
        retention-days: 90

  # Linuxæž„å»º - æš‚æ—¶å±è”½ï¼Œä¸“æ³¨Windowså¹³å°ä¿®å¤
  build-linux:
    if: false  # å±è”½Linuxæž„å»º
    runs-on: ubuntu-latest
    name: Linux 64-bit
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          libx11-dev \
          libxss1 \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm2 \
          libxcomposite-dev \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxkbcommon-dev \
          libasound2-dev \
          libxtst6 \
          libxcomposite1 \
          libxcursor1 \
          libxi6

    - name: Install Qt ${{ env.QT_VERSION }}
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        cache: true

    - name: Cache CEF Linux
      id: cache-cef-linux
      uses: actions/cache@v3
      with:
        path: third_party/cef
        key: cef-linux-x64-75.1.14-verified-v3
        restore-keys: |
          cef-linux-x64-75.1.14-verified-

    - name: Verify CEF Cache Integrity (Linux)
      id: verify-cef-cache-linux
      run: |
        echo "éªŒè¯Linux CEFç¼“å­˜å®Œæ•´æ€§..."
        CEF_VALID=false
        CEF_VERSION="75.1.14+gc81164e+chromium-75.0.3770.100"
        CEF_PLATFORM="linux64"
        CEF_BINARY_NAME="cef_binary_${CEF_VERSION}_${CEF_PLATFORM}"
        
        # æ”¯æŒå¤šç§å¯èƒ½çš„CEFç›®å½•ç»“æž„
        CEF_CHECK_PATHS=(
          "third_party/cef/${CEF_BINARY_NAME}/include/cef_version.h"
          "third_party/cef/include/cef_version.h"
          "third_party/cef/${CEF_BINARY_NAME}/cef_version.h"
        )
        
        echo "æ£€æŸ¥CEFå¤´æ–‡ä»¶çš„å¤šä¸ªå¯èƒ½è·¯å¾„..."
        
        for CHECK_PATH in "${CEF_CHECK_PATHS[@]}"; do
          echo "æ£€æŸ¥è·¯å¾„: $CHECK_PATH"
          if [[ -f "$CHECK_PATH" ]]; then
            echo "âœ“ CEFå¤´æ–‡ä»¶éªŒè¯æˆåŠŸ: $CHECK_PATH"
            CEF_VALID=true
            break
          fi
        done
        
        if [[ "$CEF_VALID" == "false" ]]; then
          echo "âœ— CEFå¤´æ–‡ä»¶åœ¨æ‰€æœ‰é¢„æœŸè·¯å¾„ä¸­éƒ½ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°ä¸‹è½½"
          if [[ -d "third_party/cef" ]]; then
            echo "æ˜¾ç¤ºå½“å‰CEFç›®å½•ç»“æž„ç”¨äºŽè¯Šæ–­:"
            find third_party/cef -name "cef_version.h" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•cef_version.hæ–‡ä»¶"
            echo "åˆ é™¤ä¸å®Œæ•´çš„CEFç¼“å­˜..."
            rm -rf third_party/cef
          fi
        fi
        
        echo "cef-valid=$CEF_VALID" >> $GITHUB_OUTPUT

    - name: Download CEF (Linux)
      if: steps.cache-cef-linux.outputs.cache-hit != 'true' || steps.verify-cef-cache-linux.outputs.cef-valid != 'true'
      run: |
        echo "ä¸‹è½½CEF for Linux x64..."
        chmod +x scripts/download-cef.sh
        scripts/download-cef.sh --platform=linux64 --force

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -G Ninja \
          -DCMAKE_INSTALL_PREFIX=/usr/local

    - name: Build Project
      run: |
        cd build
        ninja -j$(nproc)

    - name: Verify Build
      run: |
        if [ -f "build/bin/DesktopTerminal-CEF" ]; then
          echo "âœ“ Main executable found"
          ls -la build/bin/
          file build/bin/DesktopTerminal-CEF
        else
          echo "âœ— Main executable not found"
          find build -name "*DesktopTerminal*" -type f
          exit 1
        fi

    - name: Package Linux Build
      run: |
        mkdir -p artifacts/linux-x64
        cp -r build/bin/* artifacts/linux-x64/
        cp README.md todo.md artifacts/linux-x64/
        
        # Create build info
        cat > artifacts/linux-x64/BUILD_INFO.txt << 'EOF'
        DesktopTerminal-CEF Build Information
        ====================================
        Architecture: x64
        Platform: Linux 64-bit
        CEF Version: 75.1.14+gc81164e+chromium-75.0.3770.100
        Qt Version: ${{ env.QT_VERSION }}
        Build Type: ${{ env.BUILD_TYPE }}
        Build Date: $(date -u)
        Commit: ${{ github.sha }}
        EOF

    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DesktopTerminal-CEF-linux-x64
        path: artifacts/linux-x64/
        retention-days: 30

  # macOSæž„å»º - æš‚æ—¶å±è”½ï¼Œä¸“æ³¨Windowså¹³å°ä¿®å¤
  build-macos-disabled:
    if: false  # å±è”½macOSæž„å»º
    runs-on: macos-12
    name: macOS 64-bit (Disabled)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt ${{ env.QT_VERSION }}
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        cache: true

    - name: Cache CEF macOS
      id: cache-cef-macos
      uses: actions/cache@v3
      with:
        path: third_party/cef
        key: cef-macos-x64-75.1.14
        restore-keys: |
          cef-macos-x64-

    - name: Download CEF
      if: steps.cache-cef-macos.outputs.cache-hit != 'true'
      run: |
        chmod +x scripts/download-cef.sh
        scripts/download-cef.sh --platform=macosx64

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=10.12

    - name: Build Project
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu)

    - name: Verify Build
      run: |
        if [ -f "build/bin/DesktopTerminal-CEF" ]; then
          echo "âœ“ Main executable found"
          ls -la build/bin/
          file build/bin/DesktopTerminal-CEF
        else
          echo "âœ— Main executable not found"
          find build -name "*DesktopTerminal*" -type f
          exit 1
        fi

    - name: Package macOS Build
      run: |
        mkdir -p artifacts/macos-x64
        cp -r build/bin/* artifacts/macos-x64/
        cp README.md todo.md artifacts/macos-x64/
        
        # Create build info
        cat > artifacts/macos-x64/BUILD_INFO.txt << 'EOF'
        DesktopTerminal-CEF Build Information
        ====================================
        Architecture: x64
        Platform: macOS 64-bit
        CEF Version: 75.1.14+gc81164e+chromium-75.0.3770.100
        Qt Version: ${{ env.QT_VERSION }}
        Build Type: ${{ env.BUILD_TYPE }}
        Build Date: $(date -u)
        Commit: ${{ github.sha }}
        EOF

    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DesktopTerminal-CEF-macos-x64
        path: artifacts/macos-x64/
        retention-days: 30

  # ä»£ç è´¨é‡å’Œå®‰å…¨æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality & Security
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify Project Structure
      run: |
        echo "ðŸ” Checking project structure..."
        
        required_files=(
          "CMakeLists.txt"
          "README.md"
          "src/main.cpp"
          "scripts/build.sh"
          "scripts/build.bat"
          "scripts/download-cef.sh"
          "scripts/download-cef.bat"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ“ $file found"
          else
            echo "âœ— $file missing"
            exit 1
          fi
        done
        
        required_dirs=(
          "src/core"
          "src/cef"
          "src/config"
          "src/logging"
          "src/security"
          "cmake"
          "third_party/QHotkey"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ“ $dir/ found"
          else
            echo "âœ— $dir/ missing"
            exit 1
          fi
        done

    - name: Check Build Scripts
      run: |
        echo "ðŸ” Verifying build scripts..."
        
        # Check if scripts are executable
        if [ -x "scripts/build.sh" ]; then
          echo "âœ“ build.sh is executable"
        else
          echo "âœ— build.sh is not executable"
          chmod +x scripts/build.sh
        fi
        
        if [ -x "scripts/download-cef.sh" ]; then
          echo "âœ“ download-cef.sh is executable"
        else
          echo "âœ— download-cef.sh is not executable"  
          chmod +x scripts/download-cef.sh
        fi

    - name: Install Qt for CMake test
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        cache: true

    - name: Download CEF for CMake test
      run: |
        echo "ðŸ”½ Downloading CEF for CMake configuration test..."
        chmod +x scripts/download-cef.sh
        scripts/download-cef.sh --platform=linux64

    - name: Validate CMake Configuration
      run: |
        echo "ðŸ” Checking CMake configuration..."
        cmake -S . -B build-test -DCMAKE_BUILD_TYPE=Debug || {
          echo "âŒ CMake configuration failed"
          exit 1
        }
        echo "âœ“ CMake configuration successful"

    - name: Security Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        severity: 'HIGH,CRITICAL'

  # åˆ›å»ºå‘å¸ƒåŒ…ï¼ˆä»…åœ¨å‘å¸ƒæ—¶è§¦å‘ï¼‰
  create-release:
    needs: [build-windows, code-quality]  # æš‚æ—¶åªä¾èµ–Windowsæž„å»º
    runs-on: ubuntu-latest
    name: Create Release Packages
    if: github.event_name == 'release'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: DesktopTerminal-CEF-*
        merge-multiple: true

    - name: Create release packages
      run: |
        echo "ðŸ“¦ Creating release packages..."
        
        # Windows 32-bit package
        cd DesktopTerminal-CEF-windows-x86
        zip -r ../DesktopTerminal-CEF-v${{ github.ref_name }}-windows-x86.zip .
        cd ..
        
        # Windows 64-bit package  
        cd DesktopTerminal-CEF-windows-x64
        zip -r ../DesktopTerminal-CEF-v${{ github.ref_name }}-windows-x64.zip .
        cd ..
        
        # macOS package
        cd DesktopTerminal-CEF-macos-x64
        tar -czf ../DesktopTerminal-CEF-v${{ github.ref_name }}-macos-x64.tar.gz .
        cd ..
        
        # Linux package
        cd DesktopTerminal-CEF-linux-x64
        tar -czf ../DesktopTerminal-CEF-v${{ github.ref_name }}-linux-x64.tar.gz .
        cd ..
        
        # Show created packages
        ls -la *.zip *.tar.gz

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          DesktopTerminal-CEF-v${{ github.ref_name }}-windows-x86.zip
          DesktopTerminal-CEF-v${{ github.ref_name }}-windows-x64.zip
          DesktopTerminal-CEF-v${{ github.ref_name }}-macos-x64.tar.gz
          DesktopTerminal-CEF-v${{ github.ref_name }}-linux-x64.tar.gz
        body: |
          ## DesktopTerminal-CEF Release ${{ github.ref_name }}
          
          ### ðŸ“¦ åŒ…å«çš„å¹³å°
          - **Windows 32-bit**: æ”¯æŒWindows 7 SP1åŠä»¥ä¸Šç³»ç»Ÿ (CEF 75 - æœ€å¤§å…¼å®¹æ€§)
          - **Windows 64-bit**: æ”¯æŒWindows 7 SP1åŠä»¥ä¸Šç³»ç»Ÿ (CEF 75 - æœ€å¤§å…¼å®¹æ€§)  
          - **macOS 64-bit**: æ”¯æŒmacOS 10.12åŠä»¥ä¸Šç³»ç»Ÿ (CEF 75 - æœ€å¤§å…¼å®¹æ€§)
          - **Linux 64-bit**: æ”¯æŒUbuntu 16.04åŠä»¥ä¸Šç³»ç»Ÿ (CEF 75 - æœ€å¤§å…¼å®¹æ€§)
          
          ### ðŸ”§ ä¸»è¦ç‰¹æ€§
          - Qt5 + CEFé›†æˆçš„å®‰å…¨æ¡Œé¢ç»ˆç«¯
          - å®Œæ•´çš„å®‰å…¨æŽ§åˆ¶åŠŸèƒ½ï¼ˆé”®ç›˜æ‹¦æˆªã€URLè¿‡æ»¤ã€å…¨å±é”å®šï¼‰
          - è·¨å¹³å°å…¼å®¹æ€§
          - é’ˆå¯¹Windows 7 SP1 32ä½ç³»ç»Ÿçš„ç‰¹åˆ«ä¼˜åŒ–
          
          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **macOS**: macOS 10.12 æˆ–æ›´é«˜ç‰ˆæœ¬  
          - **Linux**: Ubuntu 18.04 æˆ–ç­‰æ•ˆå‘è¡Œç‰ˆ
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŒ…
          2. è§£åŽ‹åˆ°ç›®æ ‡ç›®å½•
          3. è¿è¡Œä¸»ç¨‹åºå³å¯å¼€å§‹ä½¿ç”¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}