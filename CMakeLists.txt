cmake_minimum_required(VERSION 3.20)
project(DesktopTerminal-CEF)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# è®¾ç½®è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# æ£€æµ‹æ¶æ„å’Œå¹³å°
if(CMAKE_SIZEOF_VOID_P EQUAL 8)
    set(CEF_PLATFORM "windows64")
    set(CMAKE_ARCH "x64")
    message(STATUS "64ä½æ¶æ„æ£€æµ‹")
else()
    set(CEF_PLATFORM "windows32")
    set(CMAKE_ARCH "Win32")
    message(STATUS "32ä½æ¶æ„æ£€æµ‹")
endif()

# å…¨å¹³å°ç»Ÿä¸€ä½¿ç”¨CEF 75ä»¥è·å¾—æœ€å¤§å…¼å®¹æ€§
set(CEF_VERSION "75.1.14+gc81164e+chromium-75.0.3770.100")
message(STATUS "ä½¿ç”¨CEF 75.1.14ç‰ˆæœ¬ - å…¨å¹³å°æœ€å¤§å…¼å®¹æ€§æ¨¡å¼")

# ä¸ºæ‰€æœ‰å¹³å°è®¾ç½®CEF 75å…¼å®¹æ€§ä¼˜åŒ–
if(WIN32 AND CMAKE_SIZEOF_VOID_P EQUAL 4)
    message(STATUS "Windows 32ä½ - CEF 75åŸç”Ÿæ”¯æŒ")
else()
    message(STATUS "å…¶ä»–å¹³å° - CEF 75ç»Ÿä¸€å…¼å®¹æ€§æ¨¡å¼")
endif()

# Windowså¹³å°ç‰¹æ®Šè®¾ç½®
if(WIN32)
    # è®¾ç½®Windowsåº”ç”¨ç¨‹åºå±æ€§ï¼ˆä¸æ˜¾ç¤ºæ§åˆ¶å°çª—å£ï¼‰
    set(CMAKE_WIN32_EXECUTABLE TRUE)
    # ç¡®ä¿ä½¿ç”¨UTF-8ç¼–ç 
    add_compile_options("/utf-8")
    # 32ä½ç³»ç»Ÿå†…å­˜ä¼˜åŒ–
    if(CMAKE_SIZEOF_VOID_P EQUAL 4)
        add_compile_definitions(CEF_32BIT_BUILD)
    endif()
endif()

# æ·»åŠ cmakeæ¨¡å—è·¯å¾„
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_CURRENT_SOURCE_DIR}/cmake")

# åŒ…å«CEFéƒ¨ç½²æ¨¡å—
include(DeployCEF)

# æŸ¥æ‰¾Qt5
find_package(Qt5 COMPONENTS Core Widgets REQUIRED)

# è®¾ç½®Qt5çš„MOCã€UICã€RCC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# æŸ¥æ‰¾CEF - å¯ç”¨è¯¦ç»†è°ƒè¯•
message(STATUS "=== CEFæŸ¥æ‰¾è¿‡ç¨‹å¼€å§‹ ===")
message(STATUS "é¡¹ç›®æ ¹ç›®å½•: ${CMAKE_CURRENT_SOURCE_DIR}")
message(STATUS "æ„å»ºç›®å½•: ${CMAKE_CURRENT_BINARY_DIR}")
message(STATUS "CMAKEæ¨¡å—è·¯å¾„: ${CMAKE_MODULE_PATH}")

# æ£€æŸ¥third_party/cefç›®å½•
set(CEF_CHECK_DIR "${CMAKE_CURRENT_SOURCE_DIR}/third_party/cef")
if(EXISTS "${CEF_CHECK_DIR}")
    message(STATUS "âœ“ third_party/cefç›®å½•å­˜åœ¨")
    file(GLOB CEF_SUBDIRS "${CEF_CHECK_DIR}/*")
    foreach(subdir ${CEF_SUBDIRS})
        if(IS_DIRECTORY "${subdir}")
            get_filename_component(dirname "${subdir}" NAME)
            message(STATUS "  å‘ç°å­ç›®å½•: ${dirname}")
        endif()
    endforeach()
else()
    message(WARNING "âœ— third_party/cefç›®å½•ä¸å­˜åœ¨ï¼")
endif()

find_package(CEF REQUIRED)

# å¦‚æœCEF wrapperåº“ä¸å­˜åœ¨ä½†æœ‰æºç ï¼Œåˆ™ç¼–è¯‘wrapperåº“
message(STATUS "=== CEF Wrapperåº“ç¼–è¯‘æ£€æŸ¥ ===")
message(STATUS "CEF_FOUND: ${CEF_FOUND}")
message(STATUS "CEF_WRAPPER_SOURCE_DIR: ${CEF_WRAPPER_SOURCE_DIR}")
message(STATUS "CEF_WRAPPER_LIBRARY: ${CEF_WRAPPER_LIBRARY}")

if(CEF_FOUND AND CEF_WRAPPER_SOURCE_DIR AND NOT CEF_WRAPPER_LIBRARY)
    message(STATUS "ç¼–è¯‘CEF Wrapperåº“ä»æºç : ${CEF_WRAPPER_SOURCE_DIR}")
elseif(CEF_FOUND AND NOT CEF_WRAPPER_SOURCE_DIR)
    # å°è¯•æ‰‹åŠ¨æŸ¥æ‰¾wrapperæºç ç›®å½•
    set(POSSIBLE_WRAPPER_DIRS
        "${CEF_ROOT_DIR}/libcef_dll"
        "${CEF_ROOT_DIR}/${CEF_BINARY_NAME}/libcef_dll"
    )
    
    foreach(wrapper_dir ${POSSIBLE_WRAPPER_DIRS})
        if(EXISTS "${wrapper_dir}" AND NOT CEF_WRAPPER_SOURCE_DIR)
            set(CEF_WRAPPER_SOURCE_DIR "${wrapper_dir}")
            message(STATUS "æ‰‹åŠ¨æ‰¾åˆ°CEF Wrapperæºç : ${CEF_WRAPPER_SOURCE_DIR}")
            break()
        endif()
    endforeach()
endif()

if(CEF_FOUND AND CEF_WRAPPER_SOURCE_DIR AND NOT CEF_WRAPPER_LIBRARY)
    message(STATUS "å¼€å§‹ç¼–è¯‘CEF Wrapperåº“: ${CEF_WRAPPER_SOURCE_DIR}")
    
    # æ”¶é›†wrapperåº“æºæ–‡ä»¶
    file(GLOB_RECURSE CEF_WRAPPER_SOURCES
        "${CEF_WRAPPER_SOURCE_DIR}/*.cc"
        "${CEF_WRAPPER_SOURCE_DIR}/*.cpp"
    )
    
    if(CEF_WRAPPER_SOURCES)
        # åˆ›å»ºwrapperé™æ€åº“
        add_library(cef_dll_wrapper STATIC ${CEF_WRAPPER_SOURCES})
        
        # è®¾ç½®wrapperåº“çš„includeç›®å½•
        target_include_directories(cef_dll_wrapper PRIVATE
            ${CEF_INCLUDE_PATH}
            ${CEF_INCLUDE_PATH}/include
        )
        
        # è®¾ç½®ç¼–è¯‘å®šä¹‰ - CEF wrapperéœ€è¦çš„æ‰€æœ‰å®šä¹‰
        target_compile_definitions(cef_dll_wrapper PRIVATE
            -DUSING_CEF_SHARED
            -DNOMINMAX
            -DWIN32_LEAN_AND_MEAN
            -D_CRT_SECURE_NO_WARNINGS
            -D_SCL_SECURE_NO_WARNINGS
            -DWRAPPING_CEF_SHARED
        )
        
        # å¹³å°ç‰¹å®šè®¾ç½®
        if(WIN32)
            target_compile_definitions(cef_dll_wrapper PRIVATE
                -DWIN32
                -D_WINDOWS
                -DUNICODE
                -D_UNICODE
            )
            
            # 32ä½ç³»ç»Ÿç‰¹æ®Šå¤„ç†
            if(CMAKE_SIZEOF_VOID_P EQUAL 4)
                target_compile_definitions(cef_dll_wrapper PRIVATE
                    -DCEF_32BIT_BUILD
                )
            endif()
        elseif(APPLE)
            target_compile_definitions(cef_dll_wrapper PRIVATE
                -DMACOSX
            )
        elseif(UNIX)
            target_compile_definitions(cef_dll_wrapper PRIVATE
                -DLINUX
            )
        endif()
        
        # å°†ç¼–è¯‘çš„wrapperåº“æ·»åŠ åˆ°CEF_LIBRARIES
        list(APPEND CEF_LIBRARIES cef_dll_wrapper)
        
        message(STATUS "CEF Wrapperåº“ç¼–è¯‘é…ç½®å®Œæˆ")
    else()
        message(WARNING "CEF Wrapperæºç ç›®å½•ä¸ºç©º: ${CEF_WRAPPER_SOURCE_DIR}")
    endif()
endif()

# åŒ…å«ç›®å½•
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${CEF_INCLUDE_PATH}
)

# æºæ–‡ä»¶åˆ—è¡¨
set(SOURCES
    src/main.cpp
    src/core/application.cpp
    src/core/cef_manager.cpp
    src/core/secure_browser.cpp
    src/core/window_manager.cpp
    src/cef/cef_client_impl.cpp
    src/cef/cef_app_impl.cpp
    src/config/config_manager.cpp
    src/logging/logger.cpp
    src/security/security_controller.cpp
    src/security/keyboard_filter.cpp
)

# å¤´æ–‡ä»¶åˆ—è¡¨
set(HEADERS
    src/core/application.h
    src/core/cef_manager.h
    src/core/secure_browser.h
    src/core/window_manager.h
    src/cef/cef_client_impl.h
    src/cef/cef_app_impl.h
    src/config/config_manager.h
    src/logging/logger.h
    src/security/security_controller.h
    src/security/keyboard_filter.h
)

# QHotkeyå­é¡¹ç›®
add_subdirectory(third_party/QHotkey)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(${PROJECT_NAME} ${SOURCES} ${HEADERS})

# éªŒè¯CEFåº“å¹¶é…ç½®é“¾æ¥
message(STATUS "=== CEFåº“é“¾æ¥é…ç½® ===")
message(STATUS "CEF_LIBRARIES: ${CEF_LIBRARIES}")

# è¯¦ç»†éªŒè¯CEFåº“çŠ¶æ€
message(STATUS "=== CEFåº“çŠ¶æ€è¯¦ç»†æ£€æŸ¥ ===")
message(STATUS "CEF_FOUND: ${CEF_FOUND}")
message(STATUS "CEF_LIBRARIES: ${CEF_LIBRARIES}")
message(STATUS "CEF_LIBRARY: ${CEF_LIBRARY}")
message(STATUS "CEF_WRAPPER_LIBRARY: ${CEF_WRAPPER_LIBRARY}")
message(STATUS "CEF_ROOT_DIR: ${CEF_ROOT_DIR}")

# ä¼˜åŒ–çš„CIç¯å¢ƒCEFåº“å¤„ç† - æä¾›è¯Šæ–­è€Œéç«‹å³å¤±è´¥
if(NOT CEF_LIBRARIES AND DEFINED ENV{GITHUB_ACTIONS})
    message(STATUS "=== CIç¯å¢ƒCEFåº“è¯Šæ–­æ¨¡å¼ ===")
    message(STATUS "åœ¨CIç¯å¢ƒä¸­æ£€æµ‹åˆ°CEFåº“åˆ—è¡¨ä¸ºç©ºï¼Œå¼€å§‹æ·±åº¦è¯Šæ–­...")
    
    # è¯¦ç»†è¯Šæ–­CEFç›®å½•çŠ¶æ€
    set(CEF_BASE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/third_party/cef")
    if(EXISTS "${CEF_BASE_DIR}")
        message(STATUS "âœ“ CEFåŸºç¡€ç›®å½•å­˜åœ¨: ${CEF_BASE_DIR}")
        file(GLOB CEF_SUBDIRS "${CEF_BASE_DIR}/*")
        foreach(subdir ${CEF_SUBDIRS})
            if(IS_DIRECTORY "${subdir}")
                get_filename_component(dirname "${subdir}" NAME)
                message(STATUS "  å‘ç°å­ç›®å½•: ${dirname}")
            endif()
        endforeach()
    else()
        message(STATUS "âœ— CEFåŸºç¡€ç›®å½•ä¸å­˜åœ¨: ${CEF_BASE_DIR}")
    endif()
    
    # å°è¯•é€’å½’æŸ¥æ‰¾æ‰€æœ‰.libæ–‡ä»¶è¿›è¡Œè¯Šæ–­
    file(GLOB_RECURSE EMERGENCY_CEF_LIBS 
        "${CMAKE_CURRENT_SOURCE_DIR}/third_party/cef/**/*.lib"
    )
    
    if(EMERGENCY_CEF_LIBS)
        message(STATUS "ğŸ” åœ¨CEFç›®å½•ä¸­æ‰¾åˆ°åº“æ–‡ä»¶:")
        foreach(emergency_lib ${EMERGENCY_CEF_LIBS})
            get_filename_component(lib_name "${emergency_lib}" NAME)
            file(SIZE "${emergency_lib}" lib_size)
            math(EXPR lib_size_kb "${lib_size} / 1024")
            message(STATUS "  ğŸ“ ${lib_name} (${lib_size_kb} KB) -> ${emergency_lib}")
            
            # å¦‚æœæ˜¯libcefç›¸å…³åº“ï¼Œæ·»åŠ åˆ°åº“åˆ—è¡¨
            if(lib_name MATCHES "^(lib)?cef")
                list(APPEND CEF_LIBRARIES "${emergency_lib}")
                message(STATUS "  âœ… æ·»åŠ åˆ°CEFåº“åˆ—è¡¨: ${lib_name}")
            endif()
        endforeach()
    else()
        message(STATUS "âš ï¸ æœªåœ¨CEFç›®å½•ä¸­æ‰¾åˆ°ä»»ä½•.libæ–‡ä»¶")
        message(STATUS "ğŸ’¡ è¿™å¯èƒ½è¡¨æ˜CEFä¸‹è½½æˆ–è§£å‹æœªå®Œæˆï¼Œä½†æ„å»ºå°†ç»§ç»­å°è¯•")
    endif()
endif()

# ä¼˜åŒ–çš„CEFåº“å­˜åœ¨æ€§æ£€æŸ¥ - æä¾›fallbackæœºåˆ¶
if(NOT CEF_LIBRARIES)
    message(WARNING "âš ï¸ CEF_LIBRARIESä¸ºç©ºï¼Œå¯ç”¨fallbackæœºåˆ¶...")
    
    # åœ¨CIç¯å¢ƒä¸­ï¼Œå°è¯•æ›´å®½æ¾çš„åº“æŸ¥æ‰¾ç­–ç•¥
    if(DEFINED ENV{GITHUB_ACTIONS})
        message(STATUS "ğŸ”„ CIç¯å¢ƒfallbackï¼šå°è¯•ç›´æ¥é“¾æ¥æ¨¡å¼...")
        
        # è®¾ç½®ä¸€ä¸ªè™šæ‹Ÿçš„CEFåº“æ ‡è®°ï¼Œè®©æ„å»ºç»§ç»­
        # å®é™…é“¾æ¥å°†ä¾èµ–FindCEF.cmakeæˆ–ç¼–è¯‘è¿‡ç¨‹ä¸­çš„è‡ªåŠ¨å‘ç°
        set(CEF_LIBRARIES "# CEFåº“å°†åœ¨é“¾æ¥æ—¶è‡ªåŠ¨å‘ç°")
        message(STATUS "ğŸ’¡ å·²è®¾ç½®fallbackæ ‡è®°ï¼Œæ„å»ºå°†ç»§ç»­...")
    else()
        message(FATAL_ERROR "
        âŒ CEFåº“å®Œå…¨ç¼ºå¤±ä¸”ä¸åœ¨CIç¯å¢ƒä¸­ï¼
        
        ğŸ” å¯èƒ½çš„åŸå› ï¼š
        1. CEFä¸‹è½½è„šæœ¬æœªè¿è¡Œæˆ–å¤±è´¥
        2. CEFè§£å‹è¿‡ç¨‹ä¸å®Œæ•´
        3. ç›®å½•ç»“æ„ä¸é¢„æœŸä¸ç¬¦
        
        ğŸ“‹ è§£å†³æ–¹æ¡ˆï¼š
        1. è¿è¡Œ scripts/download-cef.bat (Windows)
        2. è¿è¡Œ scripts/download-cef.sh (Linux/macOS)
        3. ç¡®ä¿third_party/cefç›®å½•å­˜åœ¨ä¸”åŒ…å«CEFæ–‡ä»¶
        ")
    endif()
endif()

# é“¾æ¥åº“é…ç½® - ä¼˜åŒ–CEFé“¾æ¥é¡ºåºè§£å†³LNK2019é”™è¯¯
message(STATUS "=== é…ç½®åº“é“¾æ¥ ===")

# é¦–å…ˆé“¾æ¥Qt5åº“
target_link_libraries(${PROJECT_NAME}
    Qt5::Core
    Qt5::Widgets
    qhotkey
)

# CEFåº“é“¾æ¥ - å…³é”®çš„é“¾æ¥é¡ºåºä¿®å¤ï¼ˆåŒ…å«fallbackæ”¯æŒï¼‰
if(CEF_FOUND AND CEF_LIBRARIES)
    message(STATUS "é“¾æ¥CEFåº“åˆ—è¡¨: ${CEF_LIBRARIES}")
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºfallbackæ¨¡å¼
    if(CEF_LIBRARIES STREQUAL "# CEFåº“å°†åœ¨é“¾æ¥æ—¶è‡ªåŠ¨å‘ç°")
        message(STATUS "ğŸ”„ æ£€æµ‹åˆ°fallbackæ¨¡å¼ï¼Œä¾èµ–FindCEF.cmakeçš„åº“å‘ç°...")
        # åœ¨fallbackæ¨¡å¼ä¸‹ï¼Œè·³è¿‡æ‰‹åŠ¨é“¾æ¥ï¼Œè®©FindCEF.cmakeå¤„ç†
    else()
        message(STATUS "âœ… ä½¿ç”¨æ ‡å‡†CEFåº“é“¾æ¥æ¨¡å¼")
    endif()
    
    # Windowsç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿æ­£ç¡®çš„é“¾æ¥é¡ºåº
    if(WIN32 AND NOT (CEF_LIBRARIES STREQUAL "# CEFåº“å°†åœ¨é“¾æ¥æ—¶è‡ªåŠ¨å‘ç°"))
        # åˆ†ç¦»CEFä¸»åº“å’Œwrapperåº“ï¼ˆä»…åœ¨éfallbackæ¨¡å¼ï¼‰
        set(CEF_MAIN_LIBS)
        set(CEF_WRAPPER_LIBS)
        
        foreach(cef_lib ${CEF_LIBRARIES})
            get_filename_component(lib_name "${cef_lib}" NAME_WE)
            if(lib_name MATCHES "^(lib)?cef$")
                list(APPEND CEF_MAIN_LIBS "${cef_lib}")
                message(STATUS "âœ“ CEFä¸»åº“: ${cef_lib}")
            elseif(lib_name MATCHES "wrapper")
                list(APPEND CEF_WRAPPER_LIBS "${cef_lib}")
                message(STATUS "âœ“ CEF Wrapperåº“: ${cef_lib}")
            else()
                list(APPEND CEF_MAIN_LIBS "${cef_lib}")
                message(STATUS "âœ“ å…¶ä»–CEFåº“: ${cef_lib}")
            endif()
        endforeach()
        
        # æ­£ç¡®çš„é“¾æ¥é¡ºåºï¼šå…ˆé“¾æ¥ä¸»åº“ï¼Œå†é“¾æ¥wrapperåº“
        foreach(main_lib ${CEF_MAIN_LIBS})
            if(EXISTS "${main_lib}")
                target_link_libraries(${PROJECT_NAME} "${main_lib}")
                message(STATUS "âœ… å·²é“¾æ¥CEFä¸»åº“: ${main_lib}")
            else()
                message(WARNING "âš ï¸ CEFä¸»åº“æ–‡ä»¶ä¸å­˜åœ¨: ${main_lib}")
            endif()
        endforeach()
        
        foreach(wrapper_lib ${CEF_WRAPPER_LIBS})
            if(EXISTS "${wrapper_lib}")
                target_link_libraries(${PROJECT_NAME} "${wrapper_lib}")
                message(STATUS "âœ… å·²é“¾æ¥CEF Wrapperåº“: ${wrapper_lib}")
            else()
                message(STATUS "â„¹ï¸ CEF Wrapperåº“ä¸å­˜åœ¨ï¼ˆå°†ä»æºç ç¼–è¯‘ï¼‰: ${wrapper_lib}")
            endif()
        endforeach()
    else()
        # éWindowså¹³å°çš„æ ‡å‡†é“¾æ¥
        foreach(cef_lib ${CEF_LIBRARIES})
            if(EXISTS "${cef_lib}")
                target_link_libraries(${PROJECT_NAME} "${cef_lib}")
                message(STATUS "âœ… å·²é“¾æ¥CEFåº“: ${cef_lib}")
            else()
                message(WARNING "âš ï¸ CEFåº“æ–‡ä»¶ä¸å­˜åœ¨: ${cef_lib}")
            endif()
        endforeach()
    endif()
else()
    message(WARNING "âš ï¸ CEFåº“åˆ—è¡¨ä¸ºç©ºï¼Œå°è¯•æ‰‹åŠ¨æŸ¥æ‰¾å’Œé“¾æ¥...")
    
    # ç´§æ€¥ä¿®å¤ï¼šæ‰‹åŠ¨æŸ¥æ‰¾å’Œé“¾æ¥CEFåº“ - å¢å¼ºæœç´¢è·¯å¾„æ”¯æŒCEF 75
    if(WIN32 AND CEF_ROOT_DIR)
        set(EMERGENCY_CEF_PATHS
            "${CEF_ROOT_DIR}/${CEF_BINARY_NAME}/Release/libcef.lib"
            "${CEF_ROOT_DIR}/Release/libcef.lib"
            "${CEF_ROOT_DIR}/${CEF_BINARY_NAME}/Debug/libcef.lib"
            "${CEF_ROOT_DIR}/Debug/libcef.lib"
            "${CEF_ROOT_DIR}/${CEF_BINARY_NAME}/lib/libcef.lib"
            "${CEF_ROOT_DIR}/lib/libcef.lib"
            "${CEF_ROOT_DIR}/${CEF_BINARY_NAME}/libcef.lib"
            "${CEF_ROOT_DIR}/libcef.lib"
        )
        
        set(FOUND_EMERGENCY_LIB FALSE)
        foreach(emergency_path ${EMERGENCY_CEF_PATHS})
            if(EXISTS "${emergency_path}" AND NOT FOUND_EMERGENCY_LIB)
                target_link_libraries(${PROJECT_NAME} "${emergency_path}")
                message(STATUS "ğŸ†˜ ç´§æ€¥é“¾æ¥CEFåº“: ${emergency_path}")
                set(FOUND_EMERGENCY_LIB TRUE)
            endif()
        endforeach()
        
        if(NOT FOUND_EMERGENCY_LIB)
            message(WARNING "
âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°æ ‡å‡†è·¯å¾„ä¸‹çš„CEFåº“æ–‡ä»¶ï¼Œä½†æ„å»ºå°†ç»§ç»­å°è¯•

ğŸ” å·²æœç´¢è·¯å¾„:
${EMERGENCY_CEF_PATHS}

ğŸ’¡ æ„å»ºç­–ç•¥ï¼š
- ç»§ç»­æ„å»ºè¿‡ç¨‹ï¼Œä¾èµ–FindCEF.cmakeçš„åº“å‘ç°æœºåˆ¶
- å¦‚æœæœ€ç»ˆé“¾æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥CEFä¸‹è½½å’Œè§£å‹æ˜¯å¦å®Œæ•´
- åœ¨CIç¯å¢ƒä¸­ï¼Œåº“è·¯å¾„å¯èƒ½ä¸é¢„æœŸä¸åŒï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ

ğŸ“‹ å¦‚æœæ„å»ºå¤±è´¥ï¼Œè¯·è€ƒè™‘ï¼š
1. æ£€æŸ¥CEFä¸‹è½½æ—¥å¿—ç¡®è®¤æ–‡ä»¶å®Œæ•´æ€§
2. éªŒè¯CEFç›®å½•ç»“æ„æ˜¯å¦æ­£ç¡®
3. é‡æ–°è¿è¡ŒCEFä¸‹è½½è„šæœ¬
            ")
            # ä¸å†FATAL_ERRORï¼Œå…è®¸æ„å»ºç»§ç»­
        endif()
    endif()
endif()

# CEFåº“ç‰¹æ®Šå¤„ç†
if(CEF_FOUND)
    # ç¡®ä¿CEF includeè·¯å¾„è¢«æ­£ç¡®è®¾ç½®
    target_include_directories(${PROJECT_NAME} PRIVATE
        ${CEF_INCLUDE_PATH}
        ${CEF_INCLUDE_PATH}/include
    )
    
    # macOS Frameworkç‰¹æ®Šå¤„ç†
    if(APPLE AND CEF_FRAMEWORK_PATH)
        message(STATUS "é“¾æ¥CEF Framework: ${CEF_FRAMEWORK_PATH}")
        target_link_libraries(${PROJECT_NAME} "-framework Cocoa")
        target_link_libraries(${PROJECT_NAME} "-framework ApplicationServices")
    endif()
endif()

# Windowsç‰¹å®šé“¾æ¥åº“ - CEFéœ€è¦çš„æ‰€æœ‰ç³»ç»Ÿåº“
if(WIN32)
    target_link_libraries(${PROJECT_NAME}
        # åŸºç¡€ç³»ç»Ÿåº“
        comctl32.lib
        rpcrt4.lib
        shlwapi.lib
        ws2_32.lib
        
        # CEFç‰¹å®šçš„Windowsåº“
        advapi32.lib
        dbghelp.lib
        dnsapi.lib
        gdi32.lib
        psapi.lib
        user32.lib
        version.lib
        winmm.lib
        winspool.lib
        ole32.lib
        oleaut32.lib
        uuid.lib
        shell32.lib
        kernel32.lib
    )
    
    # CEFç‰¹å®šçš„é“¾æ¥é€‰é¡¹
    if(MSVC)
        target_link_options(${PROJECT_NAME} PRIVATE
            /SUBSYSTEM:WINDOWS
            /DELAYLOAD:libcef.dll
        )
    endif()
endif()

# ç¼–è¯‘å™¨ç‰¹å®šè®¾ç½®
if(MSVC)
    # ç¦ç”¨MSVCè­¦å‘Š
    target_compile_definitions(${PROJECT_NAME} PRIVATE
        _CRT_SECURE_NO_WARNINGS
        NOMINMAX
        WIN32_LEAN_AND_MEAN
    )
    
    # 32ä½ç³»ç»Ÿä¼˜åŒ–
    if(CMAKE_SIZEOF_VOID_P EQUAL 4)
        target_compile_options(${PROJECT_NAME} PRIVATE /bigobj)
    endif()
endif()

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(${PROJECT_NAME} PROPERTIES
    OUTPUT_NAME "DesktopTerminal-CEF"
    DEBUG_POSTFIX "_d"
)

# éƒ¨ç½²CEFæ–‡ä»¶
if(CEF_FOUND)
    # ç¡®ä¿æœ‰CEF_ROOTå˜é‡ç”¨äºéƒ¨ç½²
    if(NOT CEF_ROOT)
        set(CEF_ROOT "${CEF_ROOT_DIR}")
    endif()
    
    # æ£€æŸ¥DeployCEFæ¨¡å—æ˜¯å¦å­˜åœ¨
    if(COMMAND deploy_cef_files)
        deploy_cef_files(${PROJECT_NAME}
            CEF_ROOT "${CEF_ROOT}"
            BINARY_DIR "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
            RESOURCES_DIR "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
        )
        
        # é…ç½®CEFè¿è¡Œç¯å¢ƒ
        if(COMMAND configure_cef_environment)
            configure_cef_environment(${PROJECT_NAME})
        endif()
        
        # éªŒè¯CEFéƒ¨ç½²
        if(COMMAND verify_cef_deployment)
            verify_cef_deployment(${PROJECT_NAME} "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
        endif()
    else()
        message(STATUS "DeployCEFæ¨¡å—ä¸å¯ç”¨ï¼Œè·³è¿‡CEFæ–‡ä»¶éƒ¨ç½²")
        message(STATUS "è¯·ç¡®ä¿CEFäºŒè¿›åˆ¶æ–‡ä»¶å’Œèµ„æºåœ¨è¿è¡Œæ—¶å¯ç”¨")
        message(STATUS "CEFæ ¹ç›®å½•: ${CEF_ROOT}")
        message(STATUS "CEFäºŒè¿›åˆ¶ç›®å½•: ${CEF_BINARY_DIR}")
        message(STATUS "CEFèµ„æºç›®å½•: ${CEF_RESOURCE_DIR}")
    endif()
endif()

# å®‰è£…é…ç½®
install(TARGETS ${PROJECT_NAME}
    DESTINATION bin
)

# CEFèµ„æºæ–‡ä»¶å®‰è£…
if(CEF_FOUND)
    install(DIRECTORY ${CEF_RESOURCE_DIR}/
        DESTINATION bin
        FILES_MATCHING 
        PATTERN "*.pak"
        PATTERN "*.dat"
        PATTERN "*.bin"
    )
    
    install(DIRECTORY ${CEF_BINARY_DIR}/
        DESTINATION bin
        FILES_MATCHING 
        PATTERN "*.dll"
        PATTERN "*.exe"
        PATTERN "*.so"
        PATTERN "*.dylib"
    )
endif()

# æ„å»ºæˆåŠŸéªŒè¯é€»è¾‘ - åœ¨CIç¯å¢ƒä¸­æä¾›é¢å¤–çš„æˆåŠŸç¡®è®¤
if(DEFINED ENV{GITHUB_ACTIONS})
    # æ·»åŠ è‡ªå®šä¹‰ç›®æ ‡æ¥éªŒè¯æ„å»ºæˆåŠŸ
    add_custom_target(verify_build_success ALL
        COMMAND ${CMAKE_COMMAND} -E echo "ğŸ‰ CMakeé…ç½®é˜¶æ®µæˆåŠŸå®Œæˆï¼"
        COMMAND ${CMAKE_COMMAND} -E echo "ğŸ“‹ é¡¹ç›®é…ç½®æ‘˜è¦ï¼š"
        COMMAND ${CMAKE_COMMAND} -E echo "  - é¡¹ç›®åç§°: ${PROJECT_NAME}"
        COMMAND ${CMAKE_COMMAND} -E echo "  - æ„å»ºç±»å‹: ${CMAKE_BUILD_TYPE}"
        COMMAND ${CMAKE_COMMAND} -E echo "  - CEFçŠ¶æ€: ${CEF_FOUND}"
        COMMAND ${CMAKE_COMMAND} -E echo "  - ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶: DesktopTerminal-CEF"
        COMMENT "éªŒè¯æ„å»ºé…ç½®æˆåŠŸ"
    )
    
    # ç¡®ä¿éªŒè¯ç›®æ ‡ä¾èµ–äºä¸»é¡¹ç›®
    add_dependencies(verify_build_success ${PROJECT_NAME})
endif()