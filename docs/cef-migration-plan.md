# CEF 75→109迁移 + URL检测自动退出功能 - 详细工作计划

## 📋 项目概述
**总工期**: 25-33个工作日 (约5-7周)  
**主要目标**: 
1. CEF从75.1.14升级至109.x版本，获得更好的安全性和JavaScript支持
2. 实现URL模式检测功能，当访问`域名或IP/#/login_s`时自动安全退出程序

---

## 🎯 第一阶段：分析准备阶段 (3-4天)

### 1.1 技术调研与风险评估 (1天)
- **CEF 109版本选择确认**
  - 下载并验证CEF 109.1.18+g97a8d9e+chromium-109.0.5414.120版本可用性
  - 确认Windows 7 SP1兼容性测试结果
  - 对比文件大小和系统要求变化

- **Breaking Changes详细分析**
  - 梳理IResourceHandler接口完整变更清单
  - 分析RequestHandler架构拆分影响范围
  - 评估NetworkService实现对现有代码的冲击
  - 识别CefSettings配置项变更需求

### 1.2 现有代码结构分析 (1天)
- **依赖关系审计**
  - 分析`src/core/secure_browser.cpp`中CEF API使用情况
  - 检查`cef_manager.h/cpp`中的CEF初始化逻辑
  - 识别所有直接使用CEF API的代码模块
  - 统计自定义ResourceHandler和RequestHandler实现

- **配置系统评估**
  - 分析当前缓存路径配置策略
  - 检查Cookie管理实现方式
  - 评估自定义协议注册逻辑（如果存在）

### 1.3 测试环境搭建 (1天)
- **并行开发环境**
  - 保留CEF 75构建环境作为回滚基础
  - 创建CEF 109独立测试分支
  - 配置并行CMake构建配置
  - 准备Windows 7测试虚拟机

- **自动化测试框架准备**
  - 设计API兼容性测试用例
  - 准备网络请求拦截测试场景
  - 建立性能基准测试环境

### 1.4 迁移策略制定 (0.5天)
- **分阶段迁移方案**
  - 确定最小可行迁移范围
  - 制定回滚触发条件和恢复流程
  - 规划渐进式功能验证策略

- **URL检测功能设计规范**
  - 定义URL模式匹配规则（正则表达式/字符串匹配）
  - 设计安全退出流程（确保日志完整性）
  - 规划配置项和开关机制

---

## 🔧 第二阶段：CEF基础设施迁移 (5-7天)

### 2.1 构建系统更新 (1-2天)
- **CMake配置更新**
  - 修改`CMakeLists.txt`中CEF版本号和下载URL
  - 更新`cmake/FindCEF.cmake`中的版本验证逻辑
  - 同步所有下载脚本（Windows/Linux/macOS）的版本号
  - 修改GitHub Actions构建配置

- **依赖项验证**
  - 确认Visual C++ 2019 Redistributable需求
  - 验证Qt 5版本兼容性
  - 检查QHotkey库与CEF 109的兼容性

### 2.2 CEF初始化逻辑迁移 (2天)
- **CefSettings配置重构**
  - 实现root_cache_path和cache_path的层级关系
  - 移除已废弃的配置项
  - 添加Windows 7特定的兼容性设置
  - 更新single_process模式配置

- **应用生命周期适配**
  - 适配新的CefApp初始化流程
  - 更新CefShutdown调用时机
  - 处理CEF消息循环集成变化

### 2.3 基础编译验证 (1-2天)
- **最小化编译测试**
  - 创建简化版本只包含基础CEF初始化
  - 验证CEF库正确链接和加载
  - 确认基础浏览器窗口创建功能
  
- **错误诊断和修复**
  - 解决编译期错误和警告
  - 修复链接器错误
  - 处理运行时初始化问题

### 2.4 配置管理系统适配 (1天)
- **ConfigManager更新**
  - 添加CEF 109特定配置项支持
  - 实现缓存路径验证逻辑
  - 更新默认配置生成

---

## 🚀 第三阶段：核心API迁移重构 (8-10天)

### 3.1 IResourceHandler接口重构 (3-4天)
- **废弃方法替换**
  - 移除`ProcessRequest()`和`ReadResponse()`实现
  - 实现新的`Open()`方法替代ProcessRequest
  - 实现`Skip()`和`Read()`方法替代ReadResponse
  - 更新`ProcessRequestAsync()`返回值类型（bool→CefReturnValue）

- **资源处理逻辑重写**
  - 重新设计资源加载状态机
  - 适配新的异步处理模式
  - 实现正确的错误处理和状态传递
  - 优化内存管理和资源释放

### 3.2 RequestHandler架构重组 (2-3天)
- **接口拆分实现**
  - 创建新的`IResourceRequestHandler`实现类
  - 从`IRequestHandler`迁移资源相关回调到新接口
  - 实现`GetResourceRequestHandler()`方法
  - 迁移`OnProtocolExecution`回调

- **Cookie管理迁移**
  - 将Cookie相关回调迁移到`IResourceRequestHandler`
  - 更新Cookie存储路径配置（迁移到cache目录）
  - 适配UI线程Cookie回调执行

- **类名和继承关系更新**
  - 替换`DefaultRequestHandler`为`RequestHandler`
  - 更新方法访问级别（public→protected virtual）
  - 实现显式接口继承

### 3.3 自定义协议和URL处理 (1天)
- **ISchemeRegistrar更新**
  - 替换布尔参数为`SchemeOptions`枚举标志
  - 更新自定义协议注册逻辑
  - 验证协议处理器兼容性

### 3.4 浏览器配置项迁移 (1天)
- **CefBrowserSettings适配**
  - 迁移`accept_language_list`到`CefRequestContextSettings`
  - 处理`background_color`配置问题
  - 更新其他受影响的浏览器设置

### 3.5 错误处理和日志系统更新 (1天)
- **线程模型适配**
  - 更新UI/IO线程回调处理
  - 修复潜在的线程安全问题
  - 适配新的错误码和异常类型

---

## 🔍 第四阶段：URL检测与自动退出功能实现 (3-4天)

### 4.1 URL监控机制设计 (1天)
- **监控点选择**
  - 在`OnLoadStart`回调中实现URL检测
  - 在`OnAddressChange`回调中添加实时监控
  - 考虑重定向和AJAX导航场景

- **模式匹配算法**
  - 实现正则表达式匹配`^https?://[^/]+/#/login_s$`
  - 支持IPv4地址格式：`^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}`
  - 支持域名格式匹配
  - 添加大小写不敏感选项

### 4.2 安全退出流程实现 (1天)
- **退出触发机制**
  - 设计延迟退出机制（防止误触发）
  - 实现退出确认对话框（可配置开关）
  - 集成现有的密码验证流程（可选）

- **日志和审计**
  - 记录触发URL和时间戳到`exit.log`
  - 添加详细的退出原因说明
  - 确保日志在程序退出前完整写入

### 4.3 配置系统集成 (0.5天)
- **配置项设计**
  - 添加`urlExitDetection.enabled`开关
  - 添加`urlExitDetection.patterns`数组支持多模式
  - 添加`urlExitDetection.confirmDialog`确认开关
  - 添加`urlExitDetection.delayMs`延迟配置

### 4.4 功能测试和调试 (1-1.5天)
- **单元测试**
  - URL模式匹配功能测试
  - 边界条件测试（特殊字符、超长URL等）
  - 性能测试（避免影响正常浏览性能）

- **集成测试**
  - 模拟实际登录页面访问场景
  - 测试与现有安全机制的兼容性
  - 验证多窗口/多标签页环境下的行为

---

## 🧪 第五阶段：集成测试与性能优化 (4-5天)

### 5.1 功能完整性测试 (2天)
- **CEF核心功能验证**
  - 基础网页加载和渲染测试
  - JavaScript执行和事件处理测试
  - 网络请求拦截和修改测试
  - Cookie存储和读取测试

- **安全功能测试**
  - 热键退出功能验证
  - 窗口焦点控制测试
  - 键盘事件拦截测试
  - 新增URL检测退出功能测试

### 5.2 兼容性测试 (1天)
- **操作系统兼容性**
  - Windows 7 SP1测试
  - Windows 10/11验证测试
  - 不同分辨率和DPI设置测试

- **硬件兼容性**
  - 低端显卡兼容性测试
  - 内存使用情况监控
  - CPU占用率分析

### 5.3 性能优化 (1-2天)
- **启动性能优化**
  - CEF初始化时间分析和优化
  - 资源加载优化
  - 内存占用基线建立

- **运行时性能调优**
  - 消息循环效率优化（已有的动态间隔机制）
  - 网络请求处理性能调优
  - 内存泄漏检测和修复

---

## 📦 第六阶段：部署验证与文档完善 (2-3天)

### 6.1 构建系统完善 (1天)
- **自动化构建验证**
  - GitHub Actions构建流程测试
  - Windows/Linux/macOS交叉编译验证
  - 安装包生成和签名测试

- **版本管理**
  - 更新版本号和变更日志
  - 标记CEF版本依赖关系
  - 创建发布分支

### 6.2 文档更新 (1天)
- **CLAUDE.md更新**
  - 更新CEF版本信息和配置指南
  - 添加URL检测功能说明
  - 更新构建要求和依赖项

- **配置文档更新**
  - 更新config.json模板和说明
  - 添加新配置项的详细说明
  - 提供迁移配置指南

### 6.3 最终验证和发布准备 (0.5-1天)
- **生产环境验证**
  - 在真实考试环境进行功能测试
  - 验证与现有系统的集成
  - 确认性能指标达标

- **回滚方案验证**
  - 确认CEF 75版本备份完整
  - 验证快速回滚流程
  - 准备应急响应预案

---

## ⚠️ 风险管控与里程碑

### 关键风险点
1. **第3.1阶段** - IResourceHandler重构可能导致网络功能异常
2. **第3.2阶段** - RequestHandler拆分可能影响现有业务逻辑
3. **第5.2阶段** - Windows 7兼容性可能出现预期外问题

### 里程碑检查点
- **里程碑1** (第2阶段末): CEF 109基础编译和运行成功
- **里程碑2** (第3阶段末): 所有API迁移完成，功能基本可用
- **里程碑3** (第4阶段末): URL检测功能完全实现并测试通过
- **里程碑4** (第5阶段末): 性能和兼容性测试全部通过

### 应急预案
- 每个阶段末设置Go/No-Go决策点
- 关键问题超过2天无法解决时启动回滚评估
- 保持CEF 75版本构建环境随时可用
- 准备中间版本（如CEF 85/90）作为备选方案

---

## 📊 总体时间安排

| 阶段 | 工作日 | 日历周 | 关键交付物 |
|------|--------|--------|------------|
| 第一阶段 | 3-4天 | 第1周 | 技术方案确认、环境准备完成 |
| 第二阶段 | 5-7天 | 第1-2周 | CEF 109基础构建成功 |
| 第三阶段 | 8-10天 | 第2-3周 | 核心API迁移完成 |
| 第四阶段 | 3-4天 | 第4周 | URL检测功能实现 |
| 第五阶段 | 4-5天 | 第4-5周 | 集成测试完成 |
| 第六阶段 | 2-3天 | 第5周 | 发布就绪 |

**总计**: 25-33个工作日，约5-7个自然周

---

## 📝 重要技术要点

### CEF 75→109 主要API变化
1. **IResourceHandler接口重构**
   - `ProcessRequest()` → `Open()`
   - `ReadResponse()` → `Skip()` + `Read()`
   - `ProcessRequestAsync()` 返回值: `bool` → `CefReturnValue`

2. **RequestHandler架构拆分**
   - 资源相关回调迁移到新的 `IResourceRequestHandler`
   - Cookie管理回调线程从IO迁移到UI
   - `DefaultRequestHandler` → `RequestHandler`

3. **配置系统变更**
   - 缓存路径必须建立层级关系: `root_cache_path` + `cache_path`
   - `accept_language_list` 迁移到 `CefRequestContextSettings`
   - Cookie路径固定在cache目录内

### URL检测功能技术规范
- **匹配模式**: `^https?://[^/]+/#/login_s$`
- **支持格式**: IPv4地址、域名
- **触发点**: `OnLoadStart` + `OnAddressChange` 回调
- **安全机制**: 延迟退出、确认对话框、完整日志记录

此计划确保了技术升级的稳妥性，同时高效实现了新功能需求，为项目的长期发展奠定了坚实基础。